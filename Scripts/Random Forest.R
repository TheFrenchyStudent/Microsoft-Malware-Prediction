if (!require("randomForest")) install.packages("randomForest"); library("randomForest")
if (!require("readr")) install.packages("readr"); library("readr")
if (!require("pROC")) install.packages("pROC"); library("pROC")
if (!require("dplyr")) install.packages("dplyr"); library("dplyr")
if (!require("caret")) install.packages("caret"); library("caret")
if (!require("MLmetrics")) install.packages("MLmetrics"); library("MLmetrics")
if (!require("splitstackshape")) install.packages("splitstackshape"); library("splitstackshape")

data <- readRDS("basetable_new_final.rds")

tokeep <- c("woe_AVProductStatesIdentifier","woe_AvSigVersion","woe_Census_SystemVolumeTotalCapacity","woe_SmartScreen",
       "woe_Census_InternalPrimaryDiagonalDisplaySizeInInches","woe_CountryIdentifier","woe_AVProductsInstalled",
       "Census_IsVirtualDevice","woe_OsBuildLab","woe_OsPlatformSubRelease",
       "Census_HasOpticalDiskDrive","woe_Census_OSBuildRevision","OsSuite",
       "woe_AppVersion","woe_Census_MDC2FormFactor","Census_IsSecureBootEnabled",
       "woe_LocaleEnglishNameIdentifier","woe_Census_OSWUAutoUpdateOptionsName","woe_Census_ActivationChannel",
       "AVProductsEnabled","woe_Census_ChassisTypeName","woe_Census_OSEdition",
       "woe_Census_FirmwareVersionIdentifier","woe_Census_FirmwareManufacturerIdentifier","RtpStateBitfield",
       "SMode","woe_Census_OSInstallTypeName" ,"woe_Census_FlightRing",
       "woe_Census_ProcessorCoreCount","Census_ProcessorClass","woe_Platform",
       "woe_Census_PrimaryDiskTotalCapacity","woe_Census_TotalPhysicalRAM","woe_Census_OSArchitecture",
       "woe_Census_OSBuildNumber", "HasDetections")


# Subset with most relevant features
data <- data[tokeep]
data$HasDetections <- as.factor(data$HasDetections)


# Smaller subset for grid-search
subset = stratified(data,"HasDetections",0.1)


# Train-test split
train_i <- sample(1:nrow(subset), .8*nrow(subset))
train <- subset[train_i,]
test <- subset[-train_i,]

### Grid-search
results <- matrix(0, ncol=5, nrow=25)
results <- data.frame(results)
colnames(results) <- c("mtry", "ntree", "auc", "accuracy", "training_time")

# Grid of parameters
mtrys <- c(1, 5, 10, 20, 35)
ntrees <- c(1, 10, 100, 500, 1000)

i <- 1
for (m in mtrys){
  for (n in ntrees){
    
    start_time <- Sys.time()
    rf <- randomForest(HasDetections ~ ., data = train, ntree=n, mtry=m)
    # Time spent fitting the model
    end_time <- Sys.time()
    training_time <- round(end_time - start_time, digits=2)
    
    preds <- as.numeric(predict(rf, test)) - 1 
    auc_score <- auc(test$HasDetections, preds)
    accu <- Accuracy(test$HasDetections, preds)
    
    # mtry
    results[i,1] <- m
    
    # ntree
    results[i, 2] <- n
    
    # auc
    results[i, 3] <- auc_score
    
    # accuracy
    results[i, 4] <- accu
    
    # training time
    results[i, 5] <- training_time
    
    # Progress
    print(paste0("Model ",i, "/25", ", mtry=", m, ", ntree=",n, ", auc=", round(auc_score, digits=3)))
    i <- i+1
  }
}


### Grid-search results
sorted_results <- arrange(results, by=desc(auc))
write.csv(sorted_results, "results_grid_search_rf.csv")


### Cross-validation for the best set of parameters
sorted_results[1:3,]

m <- sorted_results[1, 1]
n <- sorted_results[1, 2]

folds <- createFolds(subset$HasDetections, k = 5, list = TRUE, returnTrain = FALSE)

i = 1
auc_cv <- c()
accu_cv <- c()
for (fold in folds){
  train <- subset[-fold,]
  test <- subset[fold,]
  
  # Modeling
  rf <- randomForest(HasDetections ~ ., data = train, ntree=n, mtry=m)
  preds <- as.numeric(predict(rf, test)) - 1 
  auc_score <- auc(test$HasDetections, preds)
  accu <- Accuracy(test$HasDetections, preds)
  auc_cv <- c(auc_cv, auc_score)
  accu_cv <- c(accu_cv, accu)
  
  print(paste0("CV ",i, "/", length(folds)))
  
  i = i+1
} 

print(paste0("Random Forest with ", n, " trees & ",m," mtry."))
print(paste0("CV AUC score:", mean(auc_cv)))
print(paste0("CV Accuracy score:", mean(accu_cv)))



# Fitting the model on the whole subset - variable importance

rf <- randomForest(HasDetections ~ ., data = subset, ntree=1000, mtry=10)

varImpPlot(rf, n.var=10)
